<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baileys Session Manager</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --secondary: #60a5fa;
        --dark: #0f172a;
        --dark-secondary: #1e293b;
        --dark-tertiary: #334155;
        --light: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #475569;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Inter", sans-serif;
      }

      body {
        background-color: var(--dark);
        color: var(--light);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background-color: var(--dark-secondary);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        border: 1px solid var(--gray-600);
      }

      header {
        padding: 1.5rem 2rem;
        text-align: center;
        background-color: var(--dark);
        border-bottom: 1px solid var(--gray-600);
      }

      h1 {
        color: var(--light);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .content {
        padding: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--light);
      }

      input[type="text"],
      input[type="url"],
      textarea,
      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-600);
        border-radius: 8px;
        background-color: var(--dark-tertiary);
        color: var(--light);
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      input[type="text"]:focus,
      input[type="url"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      input[type="text"]::placeholder,
      input[type="url"]::placeholder,
      textarea::placeholder {
        color: var(--gray-400);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .btn-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      button {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-secondary {
        background-color: var(--gray-600);
        color: var(--light);
      }

      .btn-secondary:hover {
        background-color: var(--gray-500);
      }

      .btn-danger {
        background-color: var(--error);
        color: white;
      }

      .btn-danger:hover {
        background-color: #dc2626;
      }

      .btn-warning {
        background-color: var(--warning);
        color: white;
      }

      .btn-warning:hover {
        background-color: #d97706;
      }

      .btn-disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .section {
        margin-bottom: 2rem;
        border-radius: 12px;
        background-color: var(--dark-tertiary);
        padding: 1.5rem;
        border: 1px solid var(--gray-600);
      }

      .section h2 {
        color: var(--light);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-600);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-600);
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--light);
      }

      .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary);
        font-size: 0.75rem;
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .action-buttons {
        display: flex;
        gap: 0.75rem;
      }

      .action-button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .action-button-primary {
        background-color: var(--primary);
        color: white;
      }

      .action-button-primary:hover {
        background-color: var(--primary-dark);
      }

      .action-button-secondary {
        background-color: var(--gray-600);
        color: var(--light);
      }

      .action-button-secondary:hover {
        background-color: var(--gray-500);
      }

      .muted {
        color: var(--gray-400);
        font-size: 0.875rem;
        margin-top: 0.5rem;
      }

      .response {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 8px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9rem;
      }

      .success {
        background-color: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        color: var(--success);
      }

      .error {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: var(--error);
      }

      .qr-container {
        text-align: center;
        margin-top: 1rem;
      }

      #qr-code {
        max-width: 200px;
        margin: 0 auto;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .input-group {
        display: flex;
        flex-direction: column;
      }

      .input-group label {
        margin-bottom: 0.5rem;
      }

      .input-group input,
      .input-group textarea {
        margin-bottom: 0.5rem;
      }

      .highlighted-text {
        background-color: rgba(59, 130, 246, 0.1);
        padding: 0.25rem;
        border-radius: 4px;
      }

      /* Dark themed current tenant display */
      #current-tenant {
        padding: 0.75rem !important;
        background-color: var(--dark-tertiary) !important;
        border-radius: 8px !important;
        border: 1px solid var(--gray-600) !important;
        color: var(--light) !important;
      }

      /* Dark themed business status */
      #business-status {
        background-color: var(--dark-tertiary) !important;
        border: 1px solid var(--gray-600) !important;
        color: var(--light) !important;
      }

      #business-status.success {
        background-color: rgba(16, 185, 129, 0.1) !important;
        border: 1px solid rgba(16, 185, 129, 0.2) !important;
        color: var(--success) !important;
      }

      #business-status.error {
        background-color: rgba(239, 68, 68, 0.1) !important;
        border: 1px solid rgba(239, 68, 68, 0.2) !important;
        color: var(--error) !important;
      }

      /* Modal Dialog Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        padding-top: 60px;
      }

      .modal-content {
        background-color: var(--dark-secondary);
        margin: auto;
        padding: 20px;
        border: 1px solid var(--gray-600);
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        position: relative;
        color: var(--light);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-height: 80vh;
        overflow-y: auto;
      }

      .close-btn {
        color: var(--gray-400);
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s ease;
        line-height: 1;
      }

      .close-btn:hover,
      .close-btn:focus {
        color: white;
      }

      .modal h3 {
        color: var(--light);
        margin-bottom: 20px;
        margin-left: 10px;
      }

      #modal-response-content {
        margin-top: 10px;
      }

      .modal-body {
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
      }

      #loading-indicator {
        text-align: center;
        padding: 20px;
      }

      .loading-hidden {
        display: none !important;
      }

      .loading-visible {
        display: block;
      }

      .loader {
        border: 4px solid rgba(59, 130, 246, 0.3);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .response pre {
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .session-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .session-status.connecting {
        background-color: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.2);
        color: var(--warning);
      }

      .session-status.connected {
        background-color: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        color: var(--success);
      }

      .session-status.error {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: var(--error);
      }

      .session-status.hidden {
        display: none;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(245, 158, 11, 0.3);
        border-top: 2px solid var(--warning);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      
        .btn-row {
          flex-direction: column;
        }
      
        .action-buttons {
          flex-direction: column;
        }
      
        .section {
          padding: 1rem;
        }
      
        .qr-layout {
          flex-direction: column;
        }
      
        .qr-code-container {
          max-width: 100%;
        }
      
        .connection-steps {
          order: 2;
        }
      }
      
      /* QR Connection Dialog Styles */
      .qr-dialog {
        text-align: center;
        padding: 1rem;
      }
      
      .qr-dialog h4 {
        color: var(--light);
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
      }
      
      .qr-layout {
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        justify-content: center;
        margin: 1rem 0;
      }
      
      .qr-code-container {
        flex: 0 0 300px;
        background: #ffffff;
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid var(--gray-600);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      
      .qr-code-container img {
        max-width: 250px;
        width: 100%;
        height: auto;
        border-radius: 8px;
      }
      
      .connection-steps {
        flex: 1;
        max-width: 400px;
        text-align: left;
        background: var(--dark-tertiary);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid var(--gray-600);
      }
      
      .connection-steps h5 {
        color: var(--primary);
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
      }
      
      .connection-steps ol {
        list-style-position: inside;
        color: var(--light);
        font-size: 0.95rem;
        line-height: 1.5;
        margin: 0;
        padding-left: 0;
      }
      
      .connection-steps li {
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
      }
      
      .connection-steps li:before {
        content: "→ ";
        color: var(--primary);
        font-weight: bold;
      }
      
      .qr-status {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
        text-align: center;
      }
      
      .qr-status.connecting {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--warning);
      }
      
      @media (max-width: 768px) {
        .qr-code-container {
          padding: 0.75rem;
          flex: 1;
        }
      
        .connection-steps {
          padding: 0.75rem;
          order: 2;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Baileys Session Manager</h1>
      </header>

      <div class="content">

        <div class="form-group">
          <label>Current User:</label>
          <div
            id="current-tenant"
            style="
              padding: 0.75rem;
              background-color: var(--gray-200);
              border-radius: 8px;
              border: 1px solid var(--gray-300);
            "
          ></div>
        </div>

        <div id="session-status" class="session-status hidden">
          <div class="spinner" id="status-spinner" style="display: none;"></div>
          <span id="status-text"></span>
        </div>

        <div class="btn-row">
          <button id="start-btn" class="btn-primary">Start Session</button>
          <button id="status-btn" class="btn-primary">Check Status</button>
          <button id="logout-btn" class="btn-danger">Logout</button>
          <button id="user-management-btn" class="btn-secondary">
            User Management
          </button>
        </div>

        <div class="section">
          <div class="section-header">
            <div class="section-title">Business Profile</div>
            <div class="action-buttons">
              <button
                id="business-load-btn"
                class="action-button action-button-primary"
              >
                Load
              </button>
              <button
                id="business-refresh-btn"
                class="action-button action-button-primary"
              >
                Auto-Fetch
              </button>
              <button
                id="business-save-btn"
                class="action-button action-button-primary"
              >
                Save
              </button>
            </div>
          </div>

          <div class="grid-2">
            <div class="input-group">
              <label for="biz-name">Business Name</label>
              <input
                id="biz-name"
                type="text"
                placeholder="Your business name"
              />
            </div>

            <div class="input-group">
              <label for="biz-website">Website URL</label>
              <input
                id="biz-website"
                type="url"
                placeholder="https://example.com"
              />
            </div>

            <div class="input-group">
              <label for="biz-instagram">Instagram Profile URL</label>
              <input
                id="biz-instagram"
                type="url"
                placeholder="https://instagram.com/yourhandle"
              />
            </div>

            <div class="input-group">
              <label for="biz-location">Location URL</label>
              <input
                id="biz-location"
                type="url"
                placeholder="Google Maps URL"
              />
            </div>
          </div>

          <div class="grid-2">
            <div class="input-group">
              <label for="biz-working-hours">Working Hours</label>
              <textarea
                id="biz-working-hours"
                rows="3"
                placeholder="Mon-Fri 9:00 AM - 6:00 PM"
              ></textarea>
              <div class="muted">
                You can also paste JSON for structured hours.
              </div>
            </div>

            <div class="input-group">
              <label for="biz-shipping">Shipping Details</label>
              <textarea
                id="biz-shipping"
                rows="3"
                placeholder="Free shipping over $50. Delivery within 3-5 days."
              ></textarea>
            </div>
          </div>

          <div class="input-group">
            <label for="biz-mobiles">Mobile Numbers</label>
            <input
              id="biz-mobiles"
              type="text"
              placeholder="+919999999999, +14155552671"
            />
            <div class="muted">
              Comma-separated. Digits with optional + prefix.
            </div>
          </div>

          <div
            id="business-status"
            class="response"
            style="display: none"
          ></div>
        </div>

        <div class="section">
          <h2>Send Messages</h2>
          <div class="input-group">
            <label for="phone-number">Phone Number:</label>
            <input
              type="text"
              id="phone-number"
              placeholder="e.g. 1234567890 or 1234567890@whatsapp.net"
            />
          </div>

          <div class="input-group">
            <label for="message-text">Message:</label>
            <textarea
              id="message-text"
              rows="3"
              placeholder="Enter your message"
            ></textarea>
          </div>

          <div class="btn-row">
            <button id="check-num-btn" class="btn-primary">Check Number</button>
            <button id="send-msg-btn" class="btn-primary">Send Message</button>
          </div>
        </div>

        <div class="section">
          <h2>Conversations</h2>
          <button id="fetch-conversations-btn" class="btn-primary">
            Fetch All Conversations
          </button>
        </div>

        <div class="section">
          <h2>Messages</h2>
          <div class="input-group">
            <label for="conversation-jid">Conversation JID:</label>
            <input
              type="text"
              id="conversation-jid"
              placeholder="e.g. 1234567890@s.whatsapp.net"
            />
          </div>
          <button id="fetch-messages-btn" class="btn-primary">
            Fetch Messages
          </button>
        </div>

        <div id="response-container"></div>
      </div>

      <!-- Modal Dialog for API Responses -->
      <div id="response-modal" class="modal">
        <div class="modal-content">
          <span id="close-modal" class="close-btn">&times;</span>
          <h3 id="modal-title">API Response</h3>
          <div class="modal-body">
            <div id="loading-indicator" class="loading-hidden">
              <div class="loader"></div>
              <p>Loading...</p>
            </div>
            <div id="modal-response-content"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const currentUserDisplay = document.getElementById("current-tenant");
      const startBtn = document.getElementById("start-btn");
      const statusBtn = document.getElementById("status-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const phoneNumberInput = document.getElementById("phone-number");
      const messageTextInput = document.getElementById("message-text");
      const checkNumBtn = document.getElementById("check-num-btn");
      const sendMsgBtn = document.getElementById("send-msg-btn");
      const fetchConversationsBtn = document.getElementById(
        "fetch-conversations-btn"
      );
      const conversationJidInput = document.getElementById("conversation-jid");
      const fetchMessagesBtn = document.getElementById("fetch-messages-btn");
      const responseContainer = document.getElementById("response-container");
      const userManagementBtn = document.getElementById("user-management-btn");

      // Session status elements
      const sessionStatus = document.getElementById("session-status");
      const statusText = document.getElementById("status-text");
      const statusSpinner = document.getElementById("status-spinner");

      // Modal elements
      const modal = document.getElementById("response-modal");
      const modalContent = document.getElementById("modal-response-content");
      const closeBtn = document.getElementById("close-modal");
      const loadingIndicator = document.getElementById("loading-indicator");

      // Modal event listeners
      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });

      function showLoading() {
        modalContent.innerHTML = "";
        loadingIndicator.classList.remove("loading-hidden");
        loadingIndicator.classList.add("loading-visible");
        modal.style.display = "block";
      }

      function hideLoading() {
        loadingIndicator.classList.remove("loading-visible");
        loadingIndicator.classList.add("loading-hidden");
      }

      // Business Info Elements
      const businessLoadBtn = document.getElementById("business-load-btn");
      const businessSaveBtn = document.getElementById("business-save-btn");
      const businessRefreshBtn = document.getElementById(
        "business-refresh-btn"
      );

      const bizName = document.getElementById("biz-name");
      const bizWebsite = document.getElementById("biz-website");
      const bizInstagram = document.getElementById("biz-instagram");
      const bizLocation = document.getElementById("biz-location");
      const bizWorkingHours = document.getElementById("biz-working-hours");
      const bizShipping = document.getElementById("biz-shipping");
      const bizMobiles = document.getElementById("biz-mobiles");
      const businessStatus = document.getElementById("business-status");

      function getAuthHeaders() {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
          alert("Please login first");
          window.location.href = "login.html";
          return null;
        }
        return {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
      }

      function updateSessionStatus(statusClass, message = '') {
        sessionStatus.className = `session-status ${statusClass}`;
        statusText.textContent = message || statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
        if (statusClass === 'connecting') {
          statusSpinner.style.display = 'block';
        } else {
          statusSpinner.style.display = 'none';
        }
        sessionStatus.classList.remove('hidden');
      }

      function hideAllSections() {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
          section.style.display = 'none';
        });
      }

      function showAllSections() {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
          section.style.display = 'block';
        });
      }


      function showResponse(data, isError = false) {
        hideLoading();
        modalContent.innerHTML = "";
      
        // Set modal title dynamically
        const modalTitle = document.getElementById("modal-title");
        if (data.qrBase64) {
          modalTitle.textContent = "Connect to WhatsApp";
        } else {
          modalTitle.textContent = "API Response";
        }
      
        if (data.qrBase64 && !isError) {
          // Custom QR dialog UI
          const qrDiv = document.createElement("div");
          qrDiv.className = "qr-dialog";
      
          const title = document.createElement("h4");
          title.textContent = "Scan QR Code to Connect";
          qrDiv.appendChild(title);

          const layoutDiv = document.createElement("div");
          layoutDiv.className = "qr-layout";

          const qrContainer = document.createElement("div");
          qrContainer.className = "qr-code-container";
          const qrImg = document.createElement("img");
          qrImg.src = data.qrBase64;
          qrImg.alt = "QR Code for WhatsApp Connection";
          qrContainer.appendChild(qrImg);
          layoutDiv.appendChild(qrContainer);

          const stepsDiv = document.createElement("div");
          stepsDiv.className = "connection-steps";
          const stepsTitle = document.createElement("h5");
          stepsTitle.textContent = "How to Connect:";
          stepsDiv.appendChild(stepsTitle);

          const ol = document.createElement("ol");
          const steps = [
            "Open WhatsApp on your phone.",
            "Tap the three dots menu (Android) or Settings tab (iOS).",
            "Select 'Linked Devices'.",
            "Tap 'Link a Device'.",
            "Scan the QR code displayed on your screen."
          ];
          steps.forEach(step => {
            const li = document.createElement("li");
            li.textContent = step;
            ol.appendChild(li);
          });
          stepsDiv.appendChild(ol);
          layoutDiv.appendChild(stepsDiv);

          qrDiv.appendChild(layoutDiv);

          const statusDiv = document.createElement("div");
          statusDiv.className = "qr-status connecting";
          statusDiv.textContent = "Waiting for scan... Please scan the QR code with WhatsApp.";
          qrDiv.appendChild(statusDiv);

          modalContent.appendChild(qrDiv);
      
          // Optional: Start polling to update status when connected
          // This can be enhanced later if needed
        } else {
          // Fallback to original response display
          const responseDiv = document.createElement("div");
          responseDiv.className = `response ${isError ? "error" : "success"}`;
      
          const pre = document.createElement("pre");
          let content = "";
          if (typeof data === "string") {
            content += data;
          } else {
            content += JSON.stringify(data, null, 2);
          }
          pre.textContent = content;
          responseDiv.appendChild(pre);
          modalContent.appendChild(responseDiv);
        }
      }

      function showBusinessStatus(msg, isError = false) {
        businessStatus.style.display = "block";
        businessStatus.style.borderColor = isError ? "#f5c6cb" : "#c3e6cb";
        businessStatus.style.background = isError ? "#f8d7da" : "#d4edda";
        businessStatus.style.color = isError ? "#721c24" : "#155724";
        businessStatus.textContent =
          typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
      }

      function toArray(text) {
        if (!text) return null;
        const parts = String(text)
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        return parts.length ? parts : null;
      }

      function fromArray(arr) {
        if (!arr) return "";
        try {
          return (arr || []).join(", ");
        } catch {
          return "";
        }
      }

      startBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        showLoading();
        startBtn.disabled = true;
        startBtn.textContent = "Starting...";

        try {
          const response = await fetch(
            `/api/session/start`,
            {
              method: "POST",
              headers: headers,
            }
          );

          const data = await response.json();
          if (response.ok) {
            if (data.status === 'connected') {
              // Close modal and update status for successful connection
              modal.style.display = 'none';
              updateSessionStatus('connected', 'Session connected');
              showAllSections();
              // Still show a brief success message
              showResponse({ message: 'Successfully connected to WhatsApp!' });
            } else if (data.status === 'waiting_qr') {
              showResponse(data);
              updateSessionStatus('connecting', 'Please scan the QR code in the modal to connect');
            } else {
              showResponse(data);
            }
          } else {
            showResponse(data, true);
            updateSessionStatus('error', data.message || 'Failed to start session');
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
          updateSessionStatus('error', 'Network error: ' + error.message);
        }

        startBtn.disabled = false;
        startBtn.textContent = "Start Session";
      });

      // Business: Load current info
      businessLoadBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        businessLoadBtn.disabled = true;
        try {
          const response = await fetch(`/api/business`, {
            headers,
          });
          const data = await response.json();
          if (!response.ok) {
            showBusinessStatus(data, true);
          } else {
            const info = data?.data || {};
            bizName.value = info.name || "";
            bizWebsite.value = info.website_url || "";
            bizInstagram.value = info.instagram_url || "";
            bizLocation.value = info.location_url || "";
            bizWorkingHours.value = info.working_hours || "";
            bizShipping.value = info.shipping_details || "";
            bizMobiles.value = fromArray(info.mobile_numbers);
            showBusinessStatus("Loaded business info.");
          }
        } catch (e) {
          showBusinessStatus("Network error: " + e.message, true);
        }
        businessLoadBtn.disabled = false;
      });

      // Business: Save
      businessSaveBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        businessSaveBtn.disabled = true;
        try {
          const payload = {
            name: bizName.value || null,
            working_hours: bizWorkingHours.value || null,
            location_url: bizLocation.value || null,
            shipping_details: bizShipping.value || null,
            instagram_url: bizInstagram.value || null,
            website_url: bizWebsite.value || null,
            mobile_numbers: toArray(bizMobiles.value),
          };
          const response = await fetch(`/api/business`, {
            method: "PUT",
            headers,
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (!response.ok) {
            showBusinessStatus(data, true);
          } else {
            showBusinessStatus("Business info saved successfully.");
          }
        } catch (e) {
          showBusinessStatus("Network error: " + e.message, true);
        }
        businessSaveBtn.disabled = false;
      });

      // Business: Auto-Fetch from WhatsApp
      businessRefreshBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        businessRefreshBtn.disabled = true;
        businessRefreshBtn.textContent = "Fetching...";
        try {
          const response = await fetch(
            `/api/business/refresh`,
            {
              method: "POST",
              headers,
            }
          );
          const data = await response.json();
          if (!response.ok) {
            showBusinessStatus(data, true);
          } else {
            const info = data?.stored || {};
            bizName.value = info.name || "";
            bizWebsite.value = info.website_url || "";
            bizInstagram.value = info.instagram_url || "";
            bizLocation.value = info.location_url || "";
            bizWorkingHours.value = info.working_hours || "";
            bizShipping.value = info.shipping_details || "";
            bizMobiles.value = fromArray(info.mobile_numbers);
            showBusinessStatus(
              "Fetched and updated from WhatsApp (where available)."
            );
          }
        } catch (e) {
          showBusinessStatus("Network error: " + e.message, true);
        }
        businessRefreshBtn.disabled = false;
        businessRefreshBtn.textContent = "Auto-Fetch";
      });

      statusBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        showLoading();
        statusBtn.disabled = true;
        statusBtn.textContent = "Checking...";

        try {
          const response = await fetch(
            `/api/session/status`,
            {
              headers: headers,
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
        }

        statusBtn.disabled = false;
        statusBtn.textContent = "Check Status";
      });

      logoutBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        showLoading();
        logoutBtn.disabled = true;
        logoutBtn.textContent = "Logging out...";

        try {
          const response = await fetch(
            `/api/session/logout`,
            {
              method: "POST",
              headers: headers,
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            // Still show the response but don't treat it as a blocking error
            showResponse(data, true);
          }
        } catch (error) {
          // Show network error but don't block logout
          showResponse("Network error: " + error.message, true);
        }

        // Always clear local storage and redirect to login, regardless of API response
        localStorage.clear();
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2000);

        logoutBtn.disabled = false;
        logoutBtn.textContent = "Logout";
      });

      checkNumBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        const phoneNumber = phoneNumberInput.value.trim();
        if (!phoneNumber) {
          alert("Please enter a phone number");
          return;
        }
        showLoading();
        checkNumBtn.disabled = true;
        checkNumBtn.textContent = "Checking...";

        try {
          const response = await fetch(
            `/api/message/check-number`,
            {
              method: "POST",
              headers: headers,
              body: JSON.stringify({ to: phoneNumber }),
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
        }

        checkNumBtn.disabled = false;
        checkNumBtn.textContent = "Check Number";
      });

      sendMsgBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        const phoneNumber = phoneNumberInput.value.trim();
        const message = messageTextInput.value.trim();

        if (!phoneNumber) {
          alert("Please enter a phone number");
          return;
        }
        if (!message) {
          alert("Please enter a message");
          return;
        }

        const username = currentUserDisplay.textContent?.trim();
        if (!username) {
          alert("Username not found. Please login again.");
          return;
        }
        showLoading();
        sendMsgBtn.disabled = true;
        sendMsgBtn.textContent = "Sending...";

        try {
          const response = await fetch(
            `/api/message/send-text?username=${encodeURIComponent(username)}`,
            {
              method: "POST",
              headers: headers,
              body: JSON.stringify({ to: phoneNumber, message: message }),
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
        }

        sendMsgBtn.disabled = false;
        sendMsgBtn.textContent = "Send Message";
      });

      fetchConversationsBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;
        showLoading();
        fetchConversationsBtn.disabled = true;
        fetchConversationsBtn.textContent = "Fetching...";

        try {
          const response = await fetch(
            `/api/message/conversations`,
            {
              headers: headers,
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
        }

        fetchConversationsBtn.disabled = false;
        fetchConversationsBtn.textContent = "Fetch All Conversations";
      });

      fetchMessagesBtn.addEventListener("click", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;

        const jid = conversationJidInput.value.trim();
        if (!jid) {
          alert("Please enter a conversation JID");
          return;
        }
        showLoading();
        fetchMessagesBtn.disabled = true;
        fetchMessagesBtn.textContent = "Fetching...";

        try {
          const response = await fetch(
            `/api/message/messages?jid=${encodeURIComponent(
              jid
            )}`,
            {
              headers: headers,
            }
          );

          const data = await response.json();
          if (response.ok) {
            showResponse(data);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse("Network error: " + error.message, true);
        }

        fetchMessagesBtn.disabled = false;
        fetchMessagesBtn.textContent = "Fetch Messages";
      });

      // User management navigation
      userManagementBtn.addEventListener("click", () => {
        window.location.href = "settings.html";
      });

      // Check authentication on page load and automatically load business details
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("jwtToken");
        const username = localStorage.getItem("username");

        if (!token || !username) {
          alert("Please login first");
          window.location.href = "login.html";
          return;
        }

        // Display current username
        currentUserDisplay.textContent = username;

        // Initially hide sections
        hideAllSections();

        // Check session status on load (manual start required if not connected)
        updateSessionStatus('connecting', 'Checking session status...');
        const headers = getAuthHeaders();
        if (!headers) return;

        try {
          const sessionResponse = await fetch(`/api/session/status`, { headers });
          const sessionData = await sessionResponse.json();
          if (sessionResponse.ok && sessionData.isConnected) {
            updateSessionStatus('connected', 'Session active');
            showAllSections();
          } else {
            updateSessionStatus('error', 'Session not active. Please click "Start Session" to connect manually.');
          }
        } catch (error) {
          updateSessionStatus('error', 'Network error checking session: ' + error.message + '. Please try starting session manually.');
        }

        // Automatically load business details on page load
        try {
          const response = await fetch(`/api/business`, {
            headers,
          });
          const data = await response.json();
          if (response.ok) {
            const info = data?.data || {};
            bizName.value = info.name || "";
            bizWebsite.value = info.website_url || "";
            bizInstagram.value = info.instagram_url || "";
            bizLocation.value = info.location_url || "";
            bizWorkingHours.value = info.working_hours || "";
            bizShipping.value = info.shipping_details || "";
            bizMobiles.value = fromArray(info.mobile_numbers);
            showBusinessStatus("Loaded business info.");
          } else {
            showBusinessStatus(data, true);
          }
        } catch (e) {
          showBusinessStatus("Network error: " + e.message, true);
        }
      });
    </script>
  </body>
</html>
